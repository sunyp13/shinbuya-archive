<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>신부야여행가자 세일즈 브리핑 & 콘텐츠 아카이브</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .chart-container { position: relative; width: 100%; max-width: 500px; margin-left: auto; margin-right: auto; height: 250px; max-height: 280px; }
        .modal { transition: opacity 0.3s ease; }
        .card-detail { max-height: 0; overflow: hidden; transition: max-height 0.7s ease-in-out; }
        .card.open .card-detail { max-height: 2500px; }
        
        .star-rating { display: inline-flex; flex-direction: row-reverse; justify-content: flex-end; align-items: center; }
        .star-rating input { display: none; }
        .star-rating label {
            font-size: 2rem;
            color: #d1d5db; /* gray-300 */
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-rating label:hover,
        .star-rating label:hover ~ label,
        .star-rating input:checked ~ label {
            color: #f59e0b; /* amber-500 */
        }
        .star-rating label[for$="-half"] {
            position: relative;
            width: 0.5em;
            overflow: hidden;
            margin-right: -0.5em;
        }
        
        .star-display .star { color: #d1d5db; display: inline-block; position: relative; }
        .star-display .star.full { color: #f59e0b; }
        .star-display .star.half::before { content: '★'; color: #f59e0b; position: absolute; left: 0; top: 0; width: 50%; overflow: hidden; }
        
        .comment-preview {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .highlight-scroll {
            animation: highlight 2s ease-out;
        }
        @keyframes highlight {
            0% { background-color: rgba(252, 211, 77, 0.5); }
            100% { background-color: transparent; }
        }
        .feedback-item {
            transition: background-color 0.2s ease-in-out;
        }
        .feedback-item:hover {
            background-color: #f0f9ff; /* Tailwind sky-50 */
        }
        .card.training-card .feedback-item:hover {
             background-color: #374151; /* gray-700 */
        }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-teal-800">신부야여행가자 세일즈 브리핑 & 콘텐츠 아카이브</h1>
             <p class="text-sm text-gray-500 mt-2">User ID: <span id="user-id-display">Loading...</span></p>
        </header>

        <main>
            <section class="grid md:grid-cols-4 gap-4 mb-8">
                <div class="p-4 bg-amber-400 text-white rounded-lg shadow-lg text-center">
                    <h2 class="text-xl font-bold mb-1">🏆 이달의 발표 왕 🏆</h2>
                    <div id="potm-content"><p>데이터를 기록하여 이번 달 최고의 발표자를 확인하세요!</p></div>
                </div>
                <div class="p-4 bg-teal-600 text-white rounded-lg shadow-lg text-center">
                    <h2 class="text-xl font-bold mb-1">🏅 지난달 발표 왕 🏅</h2>
                    <div id="lpm-content"><p>지난달 기록이 없습니다.</p></div>
                </div>
                 <div class="p-4 bg-sky-600 text-white rounded-lg shadow-lg text-center">
                    <h2 class="text-xl font-bold mb-1">📢 다음주 발표 📢</h2>
                    <div id="next-presentation-content"><p>발표자가 없습니다.</p></div>
                </div>
                 <div class="p-4 bg-indigo-600 text-white rounded-lg shadow-lg text-center">
                    <h2 class="text-xl font-bold mb-1">🎓 다음주 교육 🎓</h2>
                    <div id="next-training-content"><p>교육이 없습니다.</p></div>
                </div>
            </section>

            <section id="analytics" class="p-6 bg-white rounded-lg shadow-md mb-8">
                <div class="grid lg:grid-cols-3 gap-8">
                    <div class="chart-container"><canvas id="presenter-chart"></canvas></div>
                    <div class="chart-container"><canvas id="region-chart"></canvas></div>
                    <div class="chart-container"><canvas id="winner-chart"></canvas></div>
                </div>
            </section>
            
            <section id="dashboard">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-teal-700">발표 아카이브</h2>
                    <div class="flex gap-2">
                         <button id="manage-announcements-btn" class="w-full sm:w-auto bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 transition">
                            주간 공지 관리
                        </button>
                        <button id="add-presentation-btn" class="w-full sm:w-auto bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition">
                            발표 작성하기
                        </button>
                    </div>
                </div>
                <div id="record-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 items-start"></div>
                <div id="pagination-controls" class="flex justify-center mt-8"></div>
                <p id="no-results" class="text-center text-stone-500 py-8 hidden">표시할 기록이 없습니다. '발표 작성하기' 버튼으로 시작해보세요.</p>
            </section>

        </main>
    </div>

    <!-- Modals -->
    <div id="presentation-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50">
        <form class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 space-y-4">
            <h3 class="text-2xl font-bold text-teal-700">발표 작성하기</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="p-date">발표날짜</label><input type="date" id="p-date" required class="mt-1 block w-full border-stone-300 rounded-md shadow-sm"></div>
                <div><label for="p-presenter">발표자</label><input type="text" id="p-presenter" required class="mt-1 block w-full border-stone-300 rounded-md shadow-sm"></div>
            </div>
            <div>
                <label for="p-region">발표지역</label>
                <select id="p-region" class="mt-1 block w-full border-stone-300 rounded-md shadow-sm">
                    <option value="">선택</option>
                    <option>세일즈</option><option>유럽</option><option>하와이</option><option>몰디브</option><option>칸쿤</option>
                    <option>태국</option><option>발리</option><option>괌사이판</option><option>호주</option>
                    <option>모리셔스</option><option>베트남</option><option>UAE</option><option>기타</option>
                </select>
            </div>
            <div><label for="p-topic">발표 주제</label><input type="text" id="p-topic" required class="mt-1 block w-full border-stone-300 rounded-md shadow-sm"></div>
            <div><label for="p-content">발표 내용</label><textarea id="p-content" rows="4" class="mt-1 block w-full border-stone-300 rounded-md shadow-sm"></textarea></div>
            <div><label for="p-keywords">핵심 키워드 (쉼표로 구분)</label><input type="text" id="p-keywords" class="mt-1 block w-full border-stone-300 rounded-md shadow-sm"></div>
            <div class="flex items-center">
                <input id="p-is-training" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500">
                <label for="p-is-training" class="ml-2 block text-sm text-gray-900">평가 없음 (교육)</label>
            </div>
            <div><label for="p-images">이미지 첨부 (크기 제한 있음)</label><input type="file" id="p-images" multiple accept="image/*" class="mt-1 block w-full text-sm text-stone-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100"></div>
            <div><label for="p-files">파일 첨부 (이름만 저장됨)</label><input type="file" id="p-files" multiple class="mt-1 block w-full text-sm text-stone-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-stone-50 file:text-stone-700 hover:file:bg-stone-100"></div>
            <div class="flex justify-end gap-2"><button type="button" class="form-cancel-btn px-4 py-2 rounded-lg border">취소</button><button type="submit" class="bg-teal-600 text-white px-4 py-2 rounded-lg">저장</button></div>
        </form>
    </div>

    <div id="feedback-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50">
        <form class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 space-y-4">
            <input type="hidden" id="f-presentation-id">
            <h3 class="text-2xl font-bold text-teal-700">발표 코멘트 작성</h3>
            <div><label for="f-commenter">작성자 이름</label><input type="text" id="f-commenter" required class="mt-1 block w-full border-stone-300 rounded-md shadow-sm"></div>
            <div class="space-y-4">
                <div><label for="f-strengths">잘한 점</label><textarea id="f-strengths" rows="2" class="mt-1 block w-full border-stone-300 rounded-md shadow-sm"></textarea></div>
                <div><label for="f-improvements">보완할 점</label><textarea id="f-improvements" rows="2" class="mt-1 block w-full border-stone-300 rounded-md shadow-sm"></textarea></div>
                <div><label for="f-marketing-memo">마케팅 활용요소 메모</label><textarea id="f-marketing-memo" rows="2" class="mt-1 block w-full border-stone-300 rounded-md shadow-sm"></textarea></div>
            </div>
            <div class="flex items-center">
                <label>점수</label>
                <div class="star-rating ml-4" id="f-rating">
                    <input type="radio" id="star5" name="rating" value="5"><label for="star5">★</label>
                    <input type="radio" id="star4-half" name="rating" value="4.5"><label for="star4-half">★</label>
                    <input type="radio" id="star4" name="rating" value="4"><label for="star4">★</label>
                    <input type="radio" id="star3-half" name="rating" value="3.5"><label for="star3-half">★</label>
                    <input type="radio" id="star3" name="rating" value="3"><label for="star3">★</label>
                    <input type="radio" id="star2-half" name="rating" value="2.5"><label for="star2-half">★</label>
                    <input type="radio" id="star2" name="rating" value="2"><label for="star2">★</label>
                    <input type="radio" id="star1-half" name="rating" value="1.5"><label for="star1-half">★</label>
                    <input type="radio" id="star1" name="rating" value="1"><label for="star1">★</label>
                    <input type="radio" id="star0-half" name="rating" value="0.5"><label for="star0-half">★</label>
                </div>
                <span id="f-rating-display" class="ml-4 font-bold text-lg text-amber-500">0</span>
            </div>
            <div><label for="f-reason">종합 코멘트 (평가 이유) <span class="text-red-500">*</span></label><textarea id="f-reason" rows="2" class="mt-1 block w-full border-stone-300 rounded-md shadow-sm" required></textarea></div>
            <div class="flex justify-end gap-2"><button type="button" class="form-cancel-btn px-4 py-2 rounded-lg border">취소</button><button type="submit" class="bg-teal-600 text-white px-4 py-2 rounded-lg">저장</button></div>
        </form>
    </div>

    <div id="training-feedback-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50">
        <form class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 space-y-4">
            <input type="hidden" id="tf-presentation-id">
            <h3 class="text-2xl font-bold text-gray-700">교육 코멘트 작성</h3>
            <div><label for="tf-commenter">작성자 이름</label><input type="text" id="tf-commenter" required class="mt-1 block w-full border-stone-300 rounded-md shadow-sm"></div>
            <div><label for="tf-comment">종합 코멘트</label><textarea id="tf-comment" rows="3" class="mt-1 block w-full border-stone-300 rounded-md shadow-sm"></textarea></div>
            <div><label for="tf-marketing-memo">마케팅 활용요소 메모</label><textarea id="tf-marketing-memo" rows="3" class="mt-1 block w-full border-stone-300 rounded-md shadow-sm"></textarea></div>
            <div class="flex justify-end gap-2"><button type="button" class="form-cancel-btn px-4 py-2 rounded-lg border">취소</button><button type="submit" class="bg-gray-800 text-white px-4 py-2 rounded-lg">저장</button></div>
        </form>
    </div>

    <div id="announcement-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50">
        <form class="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto p-6 space-y-4">
            <h3 class="text-2xl font-bold text-sky-700">주간 공지 관리</h3>
            <div>
                <label for="np-presenters" class="font-semibold">다음주 발표자</label>
                <p class="text-xs text-gray-500 mb-1">한 줄에 한 명씩 '이름 (직급)' 형식으로 입력해주세요.</p>
                <textarea id="np-presenters" rows="4" class="mt-1 block w-full border-stone-300 rounded-md shadow-sm" placeholder="홍길동 (대리)&#10;김철수 (사원)"></textarea>
            </div>
            <div>
                <label for="np-trainers" class="font-semibold">다음주 교육</label>
                 <p class="text-xs text-gray-500 mb-1">한 줄에 한 명씩 '이름 (직급)' 형식으로 입력해주세요.</p>
                <textarea id="np-trainers" rows="4" class="mt-1 block w-full border-stone-300 rounded-md shadow-sm" placeholder="이영희 (과장)"></textarea>
            </div>
            <div class="flex justify-end gap-2"><button type="button" class="form-cancel-btn px-4 py-2 rounded-lg border">취소</button><button type="submit" class="bg-sky-600 text-white px-4 py-2 rounded-lg">저장</button></div>
        </form>
    </div>

    <div id="presentation-detail-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-start p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl my-8 p-6 space-y-4 relative">
            <button class="form-cancel-btn absolute top-4 right-4 text-3xl text-stone-500 hover:text-stone-800">&times;</button>
            <div id="p-detail-content"></div>
        </div>
    </div>
    
    <div id="lightbox-modal" class="modal fixed inset-0 bg-black bg-opacity-75 hidden justify-center items-center p-4 z-50" data-action="close-lightbox">
        <img id="lightbox-image" src="" class="max-w-full max-h-full">
    </div>

    <div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <p id="confirm-message" class="mb-4 text-lg">이 항목을 정말 삭제하시겠습니까?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="px-6 py-2 rounded-lg border">취소</button>
                <button id="confirm-ok-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg">삭제</button>
            </div>
        </div>
    </div>

    <div id="error-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <h3 class="text-xl font-bold text-red-600 mb-4">오류 발생</h3>
            <p id="error-message" class="mb-4">오류가 발생했습니다.</p>
            <div class="flex justify-center">
                <button id="error-ok-btn" class="bg-teal-600 text-white px-6 py-2 rounded-lg">확인</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB_UaDLoTq0vQRO-8iSPZawip5--eO-ONk",
            authDomain: "shinbuya-archive.firebaseapp.com",
            projectId: "shinbuya-archive",
            storageBucket: "shinbuya-archive.firebasestorage.app",
            messagingSenderId: "611539626126",
            appId: "1:611539626126:web:7431d389dd6675d7e241df",
            measurementId: "G-GD47KLJPRQ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ===================================================================================
        // !! 중요: Firestore 보안 규칙 !!
        // "Missing or insufficient permissions" 오류가 발생할 경우,
        // Firebase 콘솔 > Firestore Database > 규칙(Rules) 탭으로 이동하여
        // 기존 규칙을 모두 삭제하고 아래 내용으로 업데이트해야 합니다.
        //
        // rules_version = '2';
        // service cloud.firestore {
        //   match /databases/{database}/documents {
        //     match /artifacts/{appId}/public/data/{collection}/{docId} {
        //       allow read, write: if request.auth != null;
        //     }
        //   }
        // }
        // ===================================================================================

        let records = [];
        let charts = {};
        let currentPage = 1;
        const itemsPerPage = 24;
        let presentationsCollection;
        let weeklyAnnouncementsDocRef;
        let userId;

        const presentationModal = document.getElementById('presentation-modal');
        const feedbackModal = document.getElementById('feedback-modal');
        const trainingFeedbackModal = document.getElementById('training-feedback-modal');
        const detailModal = document.getElementById('presentation-detail-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const errorModal = document.getElementById('error-modal');
        const announcementModal = document.getElementById('announcement-modal');
        
        let onConfirmCallback = null;

        // --- Auth Listener ---
        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in.
                userId = user.uid;
                document.getElementById('user-id-display').textContent = userId;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                presentationsCollection = collection(db, `artifacts/${appId}/public/data/presentations`);
                weeklyAnnouncementsDocRef = doc(db, `artifacts/${appId}/public/data/announcements`, 'weekly');
                loadPresentations();
                loadAnnouncements();
            } else {
                // User is signed out.
                 document.getElementById('user-id-display').textContent = 'Not signed in';
            }
        });

        // --- Initial Authentication ---
        (async () => {
            try {
                if (auth.currentUser) return;
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } catch (customTokenError) {
                        console.error("Custom token sign-in failed, falling back to anonymous:", customTokenError);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                let errorMessage = `인증에 실패했습니다: ${error.message}. 페이지를 새로고침 해주세요.`;
                if (error.code === 'auth/configuration-not-found') {
                    errorMessage = '인증 구성 오류가 발생했습니다. Firebase 콘솔의 Authentication -> Sign-in method 탭에서 "익명" 제공업체를 활성화했는지 확인해주세요.';
                }
                showErrorModal(errorMessage);
            }
        })();

        const getYearMonth = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        
        // --- Data Handling ---
        const loadPresentations = () => {
             if (!presentationsCollection) return;
            const q = query(presentationsCollection);
            onSnapshot(q, (querySnapshot) => {
                records = [];
                querySnapshot.forEach((doc) => {
                    records.push({ id: doc.id, ...doc.data() });
                });
                init();
            }, (error) => {
                console.error("Error loading presentations from Firestore: ", error);
                showErrorModal("발표 데이터를 불러오는 중 오류가 발생했습니다.");
            });
        };

        const loadAnnouncements = () => {
            if (!weeklyAnnouncementsDocRef) return;
            onSnapshot(weeklyAnnouncementsDocRef, (doc) => {
                const data = doc.exists() ? doc.data() : { presentersText: '', trainersText: '' };
                renderNextItems('next-presentation-content', data.presentersText, '발표자가 없습니다.');
                renderNextItems('next-training-content', data.trainersText, '교육이 없습니다.');
            }, (error) => {
                console.error("Error loading announcements: ", error);
                showErrorModal("주간 공지 정보를 불러오는 중 오류가 발생했습니다.");
            });
        };

        const renderNextItems = (elementId, text, emptyMessage) => {
            const contentEl = document.getElementById(elementId);
            if (!text || text.trim() === '') {
                 contentEl.innerHTML = `<p>${emptyMessage}</p>`;
                 return;
            }
            const items = text.split('\n').filter(p => p && p.trim() !== '');
            if (items.length > 0) {
                contentEl.innerHTML = `<div class="flex flex-col justify-center items-center gap-y-1">${items.map(p => `<p class="text-xl font-bold">${p}</p>`).join('')}</div>`;
            } else {
                contentEl.innerHTML = `<p>${emptyMessage}</p>`;
            }
        };

        const linkify = (text) => {
            if (!text) return 'N/A';
            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            return text.replace(urlRegex, url => `<a href="${url}" target="_blank" class="text-blue-600 hover:underline">${url}</a>`);
        };

        const renderRecords = () => {
            const listEl = document.getElementById('record-list');
            listEl.innerHTML = '';
            
            const sortedRecords = [...records].sort((a, b) => {
                const dateComparison = new Date(b.date) - new Date(a.date);
                if (dateComparison !== 0) return dateComparison;
                return b.id.localeCompare(a.id);
            });
            document.getElementById('no-results').classList.toggle('hidden', sortedRecords.length > 0);

            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedRecords = sortedRecords.slice(startIndex, startIndex + itemsPerPage);

            paginatedRecords.forEach(rec => {
                const isTraining = rec.isTraining || false;
                const totalScore = (rec.feedbacks || []).reduce((sum, f) => sum + (f.rating || 0), 0);
                const ratedFeedbacks = (rec.feedbacks || []).filter(f => f.rating !== undefined);
                const avgScore = ratedFeedbacks.length > 0 ? (totalScore / ratedFeedbacks.length).toFixed(1) : '0.0';
                
                const card = document.createElement('div');
                card.className = `card flex flex-col rounded-lg shadow-md overflow-hidden ${isTraining ? 'training-card bg-gray-800 text-white' : 'bg-white'}`;
                
                let scoreSectionHTML = '';
                if (!isTraining) {
                    scoreSectionHTML = `
                    <div class="p-4 border-b bg-stone-50 flex justify-between items-baseline">
                        <p class="text-md font-bold text-amber-500 flex items-center"><span class="text-xl mr-1">★</span> ${avgScore}</p>
                        <p class="text-xs text-stone-500"><코멘트 ${(rec.feedbacks || []).length}개></p>
                    </div>`;
                } else {
                     scoreSectionHTML = `
                    <div class="p-4 border-b bg-gray-700 flex justify-between items-baseline">
                        <p class="text-md font-bold text-gray-300">교육 자료</p>
                        <p class="text-xs text-gray-400"><코멘트 ${(rec.feedbacks || []).length}개></p>
                    </div>`;
                }

                card.innerHTML = `
                    <div class="p-4 border-b flex-grow ${isTraining ? 'border-gray-700' : ''}">
                        <div class="flex justify-between items-start">
                            <p class="text-xs ${isTraining ? 'text-gray-400' : 'text-stone-500'}">${rec.date}</p>
                            <button data-id="${rec.id}" data-action="delete-presentation" class="${isTraining ? 'text-gray-500 hover:text-red-400' : 'text-stone-400 hover:text-red-500'} text-xl">&times;</button>
                        </div>
                        <h3 class="text-md font-bold mt-1 truncate ${isTraining ? 'text-white' : 'text-teal-700'}">${rec.topic}</h3>
                        <div class="flex justify-between items-baseline mt-1">
                            <p class="text-sm font-semibold truncate ${isTraining ? 'text-gray-300' : 'text-stone-700'}">${rec.presenter}</p>
                            <p class="text-xs flex-shrink-0 ml-2 ${isTraining ? 'text-gray-400' : 'text-stone-500'}">${rec.travelRegion || ''}</p>
                        </div>
                        <button data-id="${rec.id}" data-action="view-full-detail" class="mt-2 w-full ${isTraining ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-teal-100 hover:bg-teal-200 text-teal-800'} text-xs font-bold px-3 py-1 rounded-full">내용 보기</button>
                    </div>
                    ${scoreSectionHTML}
                    <div class="card-detail p-4 space-y-2 ${isTraining ? 'bg-gray-800' : 'bg-stone-50'}">
                        <div class="p-2 border rounded-md ${isTraining ? 'border-gray-600 bg-gray-700' : 'bg-teal-50'}">
                            <button data-id="${rec.id}" data-action="${isTraining ? 'add-training-feedback' : 'add-feedback'}" class="w-full text-sm font-bold ${isTraining ? 'text-white hover:underline' : 'text-teal-700 hover:underline'}">+ 코멘트 추가</button>
                        </div>
                        <div class="space-y-3" data-feedback-list="general" data-id="${rec.id}"></div>
                    </div>
                    <div class="p-2 text-center border-t ${isTraining ? 'border-gray-700' : ''}">
                        <button data-action="toggle-card" class="text-sm font-bold ${isTraining ? 'text-white' : 'text-teal-700'}">코멘트 열기</button>
                    </div>
                `;
                listEl.appendChild(card);
                renderFeedback(rec);
            });
            renderPagination(sortedRecords.length);
        };

        const renderPagination = (totalItems) => {
            const pageCount = Math.ceil(totalItems / itemsPerPage);
            const paginationEl = document.getElementById('pagination-controls');
            paginationEl.innerHTML = '';
            if (pageCount <= 1) return;

            for (let i = 1; i <= pageCount; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = `px-4 py-2 mx-1 rounded ${currentPage === i ? 'bg-teal-600 text-white' : 'bg-white'}`;
                button.dataset.page = i;
                button.addEventListener('click', () => { currentPage = i; renderRecords(); });
                paginationEl.appendChild(button);
            }
        };

        const renderFeedback = (presentation) => {
            const feedbackList = document.querySelector(`[data-feedback-list="general"][data-id="${presentation.id}"]`);
            if (presentation.feedbacks && presentation.feedbacks.length > 0) {
                feedbackList.innerHTML = presentation.feedbacks.map(f => createFeedbackHTML(f, presentation.id, presentation.isTraining)).join('');
            } else {
                feedbackList.innerHTML = `<p class="text-sm ${presentation.isTraining ? 'text-gray-400' : 'text-stone-500'} text-center">코멘트가 없습니다.</p>`;
            }
        };

        const createFeedbackHTML = (f, presentationId, isTraining) => {
            if (isTraining) {
                return `
                <div class="feedback-item text-sm p-3 border rounded-md ${isTraining ? 'bg-gray-900 border-gray-700' : 'bg-white'}">
                    <div class="flex justify-between items-center">
                        <p class="font-bold">${f.commenter}</p>
                        <button data-pid="${presentationId}" data-fid="${f.id}" data-action="delete-comment" class="text-gray-600 hover:text-red-400 text-lg">&times;</button>
                    </div>
                    <p class="mt-2 pt-2 border-t ${isTraining ? 'border-gray-700 text-gray-300' : 'text-stone-600'} comment-preview">${f.comment || '코멘트 없음'}</p>
                </div>`;
            }

            let starsHTML = '';
            for(let i = 1; i <= 5; i++) {
                if (f.rating >= i) starsHTML += '<span class="star full">★</span>';
                else if (f.rating >= i - 0.5) starsHTML += '<span class="star half">★</span>';
                else starsHTML += '<span class="star empty">★</span>';
            }
            return `
            <div class="feedback-item text-sm p-3 border rounded-md bg-white">
                <div class="flex justify-between items-center">
                    <div class="flex items-center flex-wrap">
                        <p class="font-bold mr-2">${f.commenter}</p>
                        <span class="star-display text-amber-500">${starsHTML}</span>
                        <span class="font-bold ml-1">(${f.rating})</span>
                        <button class="text-xs text-blue-600 hover:underline ml-3" data-action="view-comment-in-popup" data-pid="${presentationId}" data-fid="${f.id}">전문보기</button>
                    </div>
                    <button data-pid="${presentationId}" data-fid="${f.id}" data-action="delete-comment" class="text-stone-300 hover:text-red-500 text-lg">&times;</button>
                </div>
                <p class="mt-2 pt-2 border-t text-stone-600 comment-preview">${f.reason || '종합 코멘트 없음'}</p>
            </div>
        `};

        const renderAnalytics = () => {
            const evaluatedRecords = records.filter(r => !r.isTraining);
            const presenterData = evaluatedRecords.reduce((acc, r) => { acc[r.presenter] = (acc[r.presenter] || 0) + 1; return acc; }, {});
            renderChart('presenter-chart', 'bar', { labels: Object.keys(presenterData), datasets: [{ label: '발표 횟수', data: Object.values(presenterData), backgroundColor: 'rgba(13, 148, 136, 0.6)' }] }, { title: '발표자별 참여 횟수' });

            const regionData = records.reduce((acc, r) => { if(r.travelRegion) acc[r.travelRegion] = (acc[r.travelRegion] || 0) + 1; return acc; }, {});
            renderChart('region-chart', 'pie', { labels: Object.keys(regionData), datasets: [{ data: Object.values(regionData), backgroundColor: ['#14b8a6', '#0d9488', '#0f766e', '#115e59', '#f59e0b', '#d97706', '#b45309', '#64748b', '#ef4444', '#dc2626', '#9333ea', '#7e22ce'] }] }, { title: '발표국가 현황', datalabels: { color: '#fff', font: { weight: 'bold' } } });
            
            const monthlyWinners = calculateMonthlyWinners();
            const winnerCounts = Object.values(monthlyWinners).flat().reduce((acc, winner) => { acc[winner.presenter] = (acc[winner.presenter] || 0) + 1; return acc; }, {});
            renderChart('winner-chart', 'bar', { labels: Object.keys(winnerCounts), datasets: [{ label: '월간 우승 횟수', data: Object.values(winnerCounts), backgroundColor: 'rgba(245, 158, 11, 0.6)' }] }, { title: '월간 우승 횟수' });
        };
        
        const renderChart = (canvasId, type, data, options) => {
            if (charts[canvasId]) charts[canvasId].destroy();
            Chart.register(ChartDataLabels);
            charts[canvasId] = new Chart(document.getElementById(canvasId), {
                type, data, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        title: { display: true, text: options.title, font: { size: 16 } },
                        legend: { display: type !== 'pie' },
                        datalabels: type === 'pie' ? options.datalabels : { display: false }
                    } 
                }
            });
        };

        const calculateMonthlyWinners = () => {
            const evaluatedRecords = records.filter(r => !r.isTraining);
            const presentationsByMonth = evaluatedRecords.reduce((acc, rec) => {
                const month = getYearMonth(new Date(rec.date));
                if (!acc[month]) acc[month] = [];
                acc[month].push(rec);
                return acc;
            }, {});

            const monthlyWinners = {};
            for (const month in presentationsByMonth) {
                const presentersInMonth = {};
                presentationsByMonth[month].forEach(rec => {
                    const feedbacks = rec.feedbacks || [];
                    if (!presentersInMonth[rec.presenter]) presentersInMonth[rec.presenter] = { totalScore: 0, feedbackCount: 0 };
                    presentersInMonth[rec.presenter].feedbackCount += feedbacks.length;
                    presentersInMonth[rec.presenter].totalScore += feedbacks.reduce((sum, f) => sum + (f.rating || 0), 0);
                });

                let topPresenters = [], maxAvgScore = -1;
                for (const presenter in presentersInMonth) {
                    const data = presentersInMonth[presenter];
                    const avgScore = data.feedbackCount > 0 ? data.totalScore / data.feedbackCount : 0;
                    if (avgScore > maxAvgScore) {
                        maxAvgScore = avgScore;
                        topPresenters = [presenter];
                    } else if (avgScore.toFixed(1) === maxAvgScore.toFixed(1) && maxAvgScore > 0) {
                        topPresenters.push(presenter);
                    }
                }
                if (topPresenters.length > 0) monthlyWinners[month] = topPresenters.map(p => ({ presenter: p, score: maxAvgScore.toFixed(1) }));
            }
            return monthlyWinners;
        };

        const updateHighlightCards = () => {
            const winners = calculateMonthlyWinners();
            const now = new Date();
            const currentMonthKey = getYearMonth(now);
            const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthKey = getYearMonth(lastMonthDate);
            
            const potm = winners[currentMonthKey];
            document.getElementById('potm-content').innerHTML = potm ? `<div class="flex justify-center items-center gap-x-4 gap-y-1 flex-wrap">${potm.map(p => `<p class="text-xl font-bold">${p.presenter} <span class="text-base font-normal">(${p.score}점)</span></p>`).join('')}</div>` : `<p>이번 달 기록이 아직 없습니다.</p>`;

            const lpm = winners[lastMonthKey];
            document.getElementById('lpm-content').innerHTML = lpm ? `<div class="flex justify-center items-center gap-x-4 gap-y-1 flex-wrap">${lpm.map(p => `<p class="text-xl font-bold">${p.presenter} <span class="text-base font-normal">(${p.score}점)</span></p>`).join('')}</div>` : `<p>지난달 기록이 없습니다.</p>`;
        };

        const openModal = (modalEl) => modalEl.classList.replace('hidden', 'flex');
        const closeModal = (modalEl) => modalEl.classList.replace('flex', 'hidden');
        
        const showConfirmModal = (message, callback) => {
            document.getElementById('confirm-message').textContent = message;
            onConfirmCallback = callback;
            openModal(confirmModal);
        };
        
        const showErrorModal = (message) => {
            document.getElementById('error-message').textContent = message;
            openModal(errorModal);
        };

        const showDetailPopupAndScroll = (presentationId, feedbackId) => {
            const presentation = records.find(r => r.id == presentationId);
            if (!presentation) return;
            const isTraining = presentation.isTraining || false;
            const detailContent = document.getElementById('p-detail-content');
            
            const createPopupFeedbackHTML = (f) => {
                if (isTraining) {
                     return `
                    <div id="popup-feedback-${f.id}" class="text-sm p-3 border rounded-md bg-white">
                        <div class="flex justify-between items-center">
                            <p class="font-bold">${f.commenter}</p>
                        </div>
                        <div class="mt-2 pt-2 border-t text-stone-600 space-y-1">
                            <p><strong>종합 코멘트:</strong> ${f.comment || 'N/A'}</p>
                            <p><strong>마케팅 활용요소:</strong> ${f.marketingMemo || 'N/A'}</p>
                        </div>
                    </div>`;
                }
                let starsHTML = '';
                for(let i = 1; i <= 5; i++) {
                    if (f.rating >= i) starsHTML += '<span class="star full">★</span>';
                    else if (f.rating >= i - 0.5) starsHTML += '<span class="star half">★</span>';
                    else starsHTML += '<span class="star empty">★</span>';
                }
                return `
                <div id="popup-feedback-${f.id}" class="text-sm p-3 border rounded-md bg-white">
                    <div class="flex justify-between items-center">
                        <p class="font-bold">${f.commenter} <span class="star-display text-amber-500 ml-2">${starsHTML}</span> (${f.rating})</p>
                    </div>
                    <div class="mt-2 pt-2 border-t text-stone-600 space-y-1">
                        <p><strong>잘한 점:</strong> ${f.strengths || 'N/A'}</p>
                        <p><strong>보완할 점:</strong> ${f.improvements || 'N/A'}</p>
                        <p><strong>마케팅 활용요소:</strong> ${f.marketingMemo || 'N/A'}</p>
                        <p><strong>종합 코멘트:</strong> ${f.reason || 'N/A'}</p>
                    </div>
                </div>
            `};
            
            let commentsHTML = (presentation.feedbacks || []).map(f => createPopupFeedbackHTML(f)).join('') || '<p>코멘트가 없습니다.</p>';
            let imagesHTML = (presentation.images || []).map(src => `<img src="${src}" class="max-w-xs my-2 rounded cursor-pointer hover:opacity-80" data-action="open-lightbox">`).join('');
            let filesHTML = (presentation.files || []).map(name => `<li class="text-sm">${name}</li>`).join('');

            detailContent.innerHTML = `
                <h3 class="text-2xl font-bold text-teal-700">${presentation.topic}</h3>
                <p class="text-sm text-stone-500">${presentation.date} / ${presentation.presenter}</p>
                <div class="mt-4 pt-4 border-t">
                    <h4 class="font-bold">발표 내용</h4>
                    <p class="mt-1 whitespace-pre-wrap">${linkify(presentation.content)}</p>
                </div>
                <div class="mt-4 pt-4 border-t">
                    <h4 class="font-bold">핵심 키워드</h4>
                    <p class="mt-1">${presentation.keywords || 'N/A'}</p>
                </div>
                ${imagesHTML ? `<div class="mt-4 pt-4 border-t"><h4 class="font-bold">첨부 이미지</h4><div class="flex flex-wrap gap-2 mt-2">${imagesHTML}</div></div>` : ''}
                ${filesHTML ? `<div class="mt-4 pt-4 border-t"><h4 class="font-bold">첨부 파일</h4><ul class="list-disc list-inside mt-2">${filesHTML}</ul></div>` : ''}
                <div class="mt-4 pt-4 border-t">
                    <h4 class="font-bold">코멘트 목록</h4>
                    <div class="mt-2 space-y-3">${commentsHTML}</div>
                </div>
            `;
            openModal(detailModal);
            
            if (feedbackId) {
                setTimeout(() => {
                    const targetComment = document.getElementById(`popup-feedback-${feedbackId}`);
                    if (targetComment) {
                        targetComment.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        targetComment.classList.add('highlight-scroll');
                        setTimeout(() => targetComment.classList.remove('highlight-scroll'), 2000);
                    }
                }, 100);
            }
        };

        document.getElementById('add-presentation-btn').addEventListener('click', () => {
            presentationModal.querySelector('form').reset();
            document.getElementById('p-date').valueAsDate = new Date();
            openModal(presentationModal);
        });

        document.getElementById('manage-announcements-btn').addEventListener('click', async () => {
            if (!weeklyAnnouncementsDocRef) {
                showErrorModal("데이터베이스 연결이 아직 준비되지 않았습니다. 잠시 후 다시 시도해주세요.");
                return;
            }
            try {
                const docSnap = await getDoc(weeklyAnnouncementsDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('np-presenters').value = data.presentersText || '';
                    document.getElementById('np-trainers').value = data.trainersText || '';
                } else {
                    announcementModal.querySelector('form').reset();
                }
                openModal(announcementModal);
            } catch (error) {
                console.error("Error opening announcement modal: ", error);
                showErrorModal("주간 공지 팝업을 여는 중 오류가 발생했습니다.");
            }
        });
        
        document.getElementById('confirm-ok-btn').addEventListener('click', () => {
            if (onConfirmCallback) onConfirmCallback();
            closeModal(confirmModal);
        });
        
        document.getElementById('confirm-cancel-btn').addEventListener('click', () => closeModal(confirmModal));
        
        document.getElementById('error-ok-btn').addEventListener('click', () => closeModal(errorModal));

        document.addEventListener('click', async e => {
            const action = e.target.dataset.action;
            const card = e.target.closest('.card');

            if (action === 'toggle-card') {
                card.classList.toggle('open');
                e.target.textContent = card.classList.contains('open') ? '코멘트 닫기' : '코멘트 열기';
            }
            else if (action === 'delete-presentation') {
                const presentationId = e.target.dataset.id;
                showConfirmModal('이 발표 기록을 정말 삭제하시겠습니까?', async () => {
                    try {
                        await deleteDoc(doc(presentationsCollection, presentationId));
                    } catch (error) {
                        console.error("Error deleting document: ", error);
                        showErrorModal("삭제 중 오류가 발생했습니다.");
                    }
                });
            }
            else if (action === 'delete-comment') {
                const pId = e.target.dataset.pid;
                const fId = e.target.dataset.fid;
                showConfirmModal('이 코멘트를 삭제하시겠습니까?', async () => {
                    const presentation = records.find(r => r.id == pId);
                    if(presentation) {
                        const updatedFeedbacks = (presentation.feedbacks || []).filter(f => f.id != fId);
                        try {
                            await setDoc(doc(presentationsCollection, pId), { feedbacks: updatedFeedbacks }, { merge: true });
                        } catch (error) {
                             console.error("Error deleting comment: ", error);
                             showErrorModal("코멘트 삭제 중 오류가 발생했습니다.");
                        }
                    }
                });
            }
            else if (action === 'add-feedback') {
                const form = feedbackModal.querySelector('form');
                form.reset();
                document.getElementById('f-rating-display').textContent = '0';
                document.getElementById('f-presentation-id').value = e.target.dataset.id;
                openModal(feedbackModal);
            }
             else if (action === 'add-training-feedback') {
                const form = trainingFeedbackModal.querySelector('form');
                form.reset();
                document.getElementById('tf-presentation-id').value = e.target.dataset.id;
                openModal(trainingFeedbackModal);
            }
            else if (action === 'view-full-detail') {
                showDetailPopupAndScroll(e.target.dataset.id, null);
            }
            else if (action === 'view-comment-in-popup') {
                const pId = e.target.closest('[data-pid]').dataset.pid;
                const fId = e.target.closest('[data-fid]').dataset.fid;
                showDetailPopupAndScroll(pId, fId);
            }
            else if (action === 'open-lightbox') {
                const lightboxModal = document.getElementById('lightbox-modal');
                document.getElementById('lightbox-image').src = e.target.src;
                openModal(lightboxModal);
            }
            else if (e.target.matches('.form-cancel-btn') || e.target.closest('.form-cancel-btn')) {
                closeModal(e.target.closest('.modal'));
            }
            else if (e.target.matches('#lightbox-modal')) {
                closeModal(e.target);
            }
        });
        
        const readFileAsDataURL = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        presentationModal.querySelector('form').addEventListener('submit', async e => {
            e.preventDefault();
            
            const imageFiles = [...document.getElementById('p-images').files];
            const otherFiles = [...document.getElementById('p-files').files];
            
            let imageDataUrls = [];
            try {
                const imagePromises = imageFiles.map(readFileAsDataURL);
                imageDataUrls = await Promise.all(imagePromises);
            } catch (error) {
                 showErrorModal("이미지 파일을 읽는 중 오류가 발생했습니다.");
                 return;
            }
            
            const newPresentation = {
                date: document.getElementById('p-date').value,
                presenter: document.getElementById('p-presenter').value,
                travelRegion: document.getElementById('p-region').value,
                topic: document.getElementById('p-topic').value,
                content: document.getElementById('p-content').value,
                keywords: document.getElementById('p-keywords').value,
                isTraining: document.getElementById('p-is-training').checked,
                images: imageDataUrls,
                files: otherFiles.map(f => f.name),
                feedbacks: []
            };
            
            try {
                await addDoc(presentationsCollection, newPresentation);
                closeModal(presentationModal);
                currentPage = 1;
            } catch (error) {
                console.error("Error adding document: ", error);
                if (error.code === 'resource-exhausted' || (error.message && error.message.includes('exceeds the maximum'))) {
                     showErrorModal('저장 공간이 부족합니다. 첨부 파일의 크기가 너무 크거나, 저장된 데이터가 많을 수 있습니다. 오래된 기록을 삭제하거나 파일 크기를 줄여주세요.');
                } else {
                    showErrorModal("데이터 저장 중 오류가 발생했습니다.");
                }
            }
        });

        feedbackModal.querySelector('form').addEventListener('submit', async e => {
            e.preventDefault();
            const presentationId = document.getElementById('f-presentation-id').value;
            const presentation = records.find(r => r.id == presentationId);
            if (!presentation) return;

            const newFeedback = {
                id: Date.now().toString(),
                commenter: document.getElementById('f-commenter').value,
                rating: parseFloat(document.querySelector('input[name="rating"]:checked')?.value || 0),
                strengths: document.getElementById('f-strengths').value,
                improvements: document.getElementById('f-improvements').value,
                marketingMemo: document.getElementById('f-marketing-memo').value,
                reason: document.getElementById('f-reason').value
            };
            
            const updatedFeedbacks = [...(presentation.feedbacks || []), newFeedback];
            
            try {
                const docRef = doc(presentationsCollection, presentationId);
                await setDoc(docRef, { feedbacks: updatedFeedbacks }, { merge: true });
                closeModal(feedbackModal);
            } catch (error) {
                console.error("Error adding feedback: ", error);
                showErrorModal("코멘트 저장 중 오류가 발생했습니다.");
            }
        });

        trainingFeedbackModal.querySelector('form').addEventListener('submit', async e => {
            e.preventDefault();
            const presentationId = document.getElementById('tf-presentation-id').value;
            const presentation = records.find(r => r.id == presentationId);
            if (!presentation) return;

            const newFeedback = {
                id: Date.now().toString(),
                commenter: document.getElementById('tf-commenter').value,
                comment: document.getElementById('tf-comment').value,
                marketingMemo: document.getElementById('tf-marketing-memo').value,
            };
            
            const updatedFeedbacks = [...(presentation.feedbacks || []), newFeedback];
            
            try {
                const docRef = doc(presentationsCollection, presentationId);
                await setDoc(docRef, { feedbacks: updatedFeedbacks }, { merge: true });
                closeModal(trainingFeedbackModal);
            } catch (error) {
                console.error("Error adding training feedback: ", error);
                showErrorModal("교육 코멘트 저장 중 오류가 발생했습니다.");
            }
        });
        
        announcementModal.querySelector('form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const presentersText = document.getElementById('np-presenters').value;
            const trainersText = document.getElementById('np-trainers').value;
            
            try {
                await setDoc(weeklyAnnouncementsDocRef, { presentersText, trainersText });
                closeModal(announcementModal);
            } catch (error) {
                console.error("Error saving announcements: ", error);
                showErrorModal("주간 공지 저장 중 오류가 발생했습니다.");
            }
        });

        document.getElementById('f-rating').addEventListener('change', e => {
            document.getElementById('f-rating-display').textContent = e.target.value;
        });

        function init() {
            renderRecords();
            renderAnalytics();
            updateHighlightCards();
        }
    </script>
</body>
</html>
